---
title: "Лабораторная работа №2"
author: "Бессмертная М.М."
date: "`r format(Sys.Date(), '%d  %B  %Y')`"
output: 
  word_document: 
    reference_docx: word_styles.docx

---

```{r setup, include = FALSE}
# Загрузка библиотек
library('knitr')
library('stats') 

knitr::opts_chunk$set(echo = FALSE)
#счётчик для таблиц
table.num <- 1
#счётчик для рисунков
pic.num <- 1
```


## Импорт данных
Импортируем объекты, сохранённые в рабочем пространстве по итогу лабораторной №1.
```{r}
# загрузка объектов из сохранённого рабочего пространства
load('test_lab1_Бессмертная.RData')
# просмотр списка объектов
ls()
```
# Раздел I.

## Изначальная регрессионная модель, основанная на Лабораторной №1
Модель 0: $Y = 140385,48 + 134,6743 \cdot X1 + 0,1186\cdot X3$, где

* `Y` (*RTPC.2017*) – оборот розничной торговли на душу населения;   

* `X1` (*SBP.2017*) – число малых предприятий на 10000 человек населения;   

* `X3` (*CBE.2016*) – расходы консолидированных бюджетов субъектов Российской Федерации: всего.

По количеству `r nrow(reg.df)`-x наблюдений.

## Оценка параметров этой модели

#### Таблица `r table.num` - описательные статистики модели 1
```{r echo=FALSE}
# регрессия по всем регионам
fit.1 <- lm(RTPC.2017 ~ SBP.2017 + CBE.2016, 
            data = reg.df)
kable(round(summary(fit.1)$coef, 4))
table.num <- table.num + 1

#строим график
par(mfrow = c(1, 2))
plot(RTPC.2017 ~ SBP.2017 + CBE.2016, 
            data = reg.df)
par(mfrow = c(1, 1))
pic.num <- pic.num + 1
```

#### Рис. `r pic.num`. график разброса начальной модели


**Проверка значимости для коэффициента при SBP.2017.**

H0: (параметр) коэфф. при SBP.2017 равен 0 в генеральной совокупности (не значим);

H1: (параметр) коэфф. при SBP.2017 не равен 0 в генеральной совокупности (значим).

Проверим значимость при помощи p-значения.

**Напоминание:**
*Сравниваем p-значение и $\alpha$ (Уровень значимости = 0,05);*
*Если p-значение > $\alpha$, то принимается гипотеза H0, в ином случае принимается противоположная гипотеза H1.*

P-значение при SBP.2017 = $0,052>\alpha$ => принимается гипотеза H0. **Параметр не значим.**

**Проведём аналогичную проверку коэффициента линейной регрессии при CBE.2016.**

P-значение при CBE.2016 = $0,0000<\alpha$ => принимается гипотеза H1. **Параметр значим.**

## Исключение незначимого параметра из модели (Х1)
```{r}
fit.1 <- lm(RTPC.2017 ~  CBE.2016, 
            data = reg.df)
kable(round(summary(fit.1)$coef, 4))
table.num <- table.num + 1
```

Явный вид модели 1: $RTPC.2017 = 157477,193 +  0,1423\cdot CBE.2016$.

P-значение при CBE.2016 = $0,0000<\alpha$ => принимается гипотеза H1. **Параметр значим.**

## Модель с переменной структурой по федеральным округам.

Построим модель с переменной структурой, используя в качестве параметра принадлежность каждого региона к федеральному округу.
Для этого включим соответсвующие фиктивные переменные как в константу, так и в коэффициенты.

#### Таблица `r table.num` - описательные статистики модели по федеральным округам
```{r}
fit.1.fo <- lm(RTPC.2017 ~ FO*CBE.2016, 
            data = reg.df) 
kable(round(summary(fit.1.fo)$coef, 4))
table.num <- table.num + 1
```

Модель в целом незначима, но скорректированный коэффициент детерминации у неё выше, чем у модели по всем регионам (`r round(summary(fit.1.fo)$r.sq, 3)*100`%). В приведенной таблице видно, что у модели много незначимых параметров.
Исключать их последовательно вручную трудоёмко, поэтому мы воспользуемся пользовательской функцией для проведения
процедуры последовательного исключения регрессоров.

Сгенерируем матрицу независимых переменных функцией
*model.matrix()*. После загружаем функцию для исключения незначимых регрессоров
из файла «removeFactorsByPValue.R» в рабочей директории и применяем её
к модели с переменной структурой.

### Модель без поправки:


#### Таблица `r table.num` - описательные статистики модели по федеральным округам без поправки
```{r}
X.matrix <- model.matrix(RTPC.2017 ~ FO*CBE.2016, 
            data = reg.df)
data.fit <- cbind(RTPC.2017 = reg.df$RTPC.2017, 
                  data.frame(X.matrix)[, -1])
data.fit.1.fo <- data.fit
source('https://raw.githubusercontent.com/aksyuk/R-Practice-basics/master/user_functions/removeFactorsByPValue.R')
fit.1.fo <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'RTPC.2017')
kable(round(summary(fit.1.fo)$coef, 4))
table.num <- table.num + 1
```
Все коэффициенты модели значимы и она имеет высокий уровень коэффициента детерминации. ($R^2 =$ `r round(summary(fit.1.fo)$r.sq, 3)`)

Значимы константы для Северо-Западного, Северо-Кавказского и Центрального федеральных
округов, а также коэффициенты при независимых переменных для некоторых округов. 


*(CBE.2016 с Западным, Северо-Кавказким и Центральным федеральными округами)*


### Модель с поправкой Бонферрони:

Явный вид модели 2: $RTPC.2017 = 173372,6 + 0,3349 \cdot CBE.2016$.


#### Таблица `r table.num` - описательные статистики модели по федеральным округам с поправкой Бонферрони
```{r}
fit.1.foB <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'RTPC.2017',
                                   p.adj.method = 'bonferroni')
kable(round(summary(fit.1.foB)$coef, 4))
table.num <- table.num + 1
```
Коэффициент модели при *SBP.2017* значим, однако коэффициент детерминации заметно понизился ($R^2 =$ `r round(summary(fit.1.foB)$r.sq, 3)`).

## Сравнение моделей по качеству.

Сравним три полученные модели: изначальную, с поправкой по ФО и без поправки по ФО.


#### Таблица `r table.num` - сравнение трёх моделей
```{r}
models.list <- list(fit.1, fit.1.foB, fit.1.fo)
names(models.list) <- c('fit.1', 'fit.1.foBonferroni', 'fit.1.fo')
df.goodness.of.fit <- data.frame(Модель = names(models.list), 
                                       R.2.скорр = 0,
                                       F.расч = 0,
                                       Станд.Ошибка = 0)
for (i in 1:length(models.list)) {
  # скорректированный R-квадрат
  df.goodness.of.fit[i, 'R.2.скорр'] <- 
    round(summary(models.list[[i]])$adj.r.squared, 3)
  # F расчётное
  df.goodness.of.fit[i, 'F.расч'] <- 
    round(summary(models.list[[i]])$fstatistic[1], 2)
  # стандартная ошибка
  df.goodness.of.fit[i, 'Станд.Ошибка'] <- 
    round(summary(models.list[[i]])$sigma, 1)
}
kable(df.goodness.of.fit)
table.num <- table.num + 1
```

Результат: 

По столбцу $R^2$ больше всего подходит третья модель;
По столбцу F.расч - первая;
По минимальной Стандартной ошибке - третья.

Таким образом, модель по федеральным округам без поправки (fit.1.fo) является наиболее подходящей.


**Явный вид модели 3: $RTPC.2017 = 176743,14 + 0,3851 \cdot CBE.2016 -58357,23 \cdot FOПФО - 106121,21 \cdot FOСКФО - 70611,01 \cdot FOСФО - 35482,21 \cdot FOУФО - 54538,28 \cdot FOЮФО -0,3539 \cdot FOСЗФО.CBE.2016 + 0,7666 \cdot FOСКФО.CBE.2016 - 0,2712 \cdot FOЦФО.CBE.2016$.**

* * *

* * *

# Раздел II.
```{r, echo = FALSE}
reg.df1 <- cbind(reg.df$FO,log(reg.df[,2:6]))
colnames(reg.df1)<- colnames(reg.df)
```

## Изначальная регрессионная модель для логарифмированных данных, основанная на Лабораторной №1
Модель 0: $Y = 9,2969 + 0,1816 \cdot X1 + 0,1645\cdot X3$, где

* `Y` (*RTPC.2017*) – оборот розничной торговли на душу населения;   

* `X1` (*SBP.2017*) – число малых предприятий на 10000 человек населения;   

* `X3` (*CBE.2016*) – расходы консолидированных бюджетов субъектов Российской Федерации: всего;

По количеству `r nrow(reg.df1)` наблюдений.

## Оценка параметров этой модели


#### Таблица `r table.num` - описательные статистики логарифмированной модели 1

```{r}
# регрессия по всем регионам (логарифмированные данные)
fit.11 <- lm(RTPC.2017 ~ SBP.2017 + CBE.2016, 
            data = reg.df1)
kable(round(summary(fit.11)$coef, 4))
table.num <- table.num + 1
par(mfrow = c(1, 2))
plot(RTPC.2017 ~ SBP.2017 + CBE.2016, 
            data = reg.df1)
par(mfrow = c(1, 1))
pic.num <- pic.num + 1
```

#### Рис. `r pic.num`. график разброса модели на логарифмированных данных

## Проверка значимости для логарифмированных значений:

**Проверка значимости для коэффициента при SBP.2017.**

H0: (параметр) коэфф. при SBP.2017 равен 0 в генеральной совокупности (не значим);

H1: (параметр) коэфф. при SBP.2017 не равен 0 в генеральной совокупности (значим).

Проверим значимость при помощи p-значения. ( $\alpha = 0,05$ )

P-значение при SBP.2017 = $0,001<\alpha$ => принимается гипотеза H1. **Параметр значим.**

**Проведём похожую проверку коэффициента при CBE.2016.**

P-значение при CBE.2016 = $0,000<\alpha$ => принимается гипотеза H1. **Параметр значим.**

Все имеющиеся параметры значимы, исключать регрессоры не требуется. $R^2 =$ `r round(summary(fit.11)$r.sq, 3)`. 42% исходного разброса зависимой переменной Y (оборота розничной торговли на душу населения) объясняет разброс объясняющих переменных X1 (число малых предприятий на 10000 человек населения), X3 (расходы консолидированных бюджетов субъектов Российской Федерации: всего).

Явный вид модели 1: $Y = 9,2969 + 0,1816 \cdot SBP.2017 + 0,1645\cdot CBE.2016$.

## Модель с переменной структурой по федеральным округам (логарифмированные данные).

Построим модель с переменной структурой, используя в качестве параметра принадлежность каждого региона к федеральному округу.
Для этого включим соответсвующие фиктивные переменные как в константу, так и в коэффициенты.

#### Таблица `r table.num` - описательные статистики логарифмированной модели по федеральным округам
```{r}
fit.11.fo <- lm(RTPC.2017 ~ FO*(SBP.2017 + CBE.2016), 
            data = reg.df1) 
kable(round(summary(fit.11.fo)$coef, 4))
table.num <- table.num + 1
```

Модель в целом незначима, но скорректированный коэффициент
детерминации у неё выше, чем у модели по всем регионам (`r round(summary(fit.11.fo)$r.sq, 3)*100`%).В приведенной таблице видно, что у модели много незначимых параметров.
Исключать их последовательно вручную трудоёмко, поэтому мы воспользуемся пользовательской функцией, которая
проводит процедуру последовательного исключения регрессоров.

Сгенерируем матрицу независимых переменных функцией
*model.matrix()*. После загружаем функцию для исключения незначимых регрессоров
из файла «removeFactorsByPValue.R» в рабочей директории и применяем её
к модели с переменной структурой.


### Модель без поправки:


#### Таблица `r table.num` - описательные статистики логарифмированной модели по федеральным округам без поправки
```{r}
X.matrix <- model.matrix(RTPC.2017 ~ FO*(SBP.2017 + CBE.2016), 
            data = reg.df1)
data.fit <- cbind(RTPC.2017 = reg.df1$RTPC.2017, 
                  data.frame(X.matrix)[, -1])
data.fit.11.fo <- data.fit
source('https://raw.githubusercontent.com/aksyuk/R-Practice-basics/master/user_functions/removeFactorsByPValue.R')
fit.11.fo <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'RTPC.2017')
kable(round(summary(fit.11.fo)$coef, 4))
table.num <- table.num + 1
```
Все коэффициенты модели значимы и она имеет высокий уровень коэффициента детерминации. $R^2 =$ `r round(summary(fit.11.fo)$r.sq, 3)`.

Значимы константы для Приволжского, Северо-Западного, Северо-Кавказского и Северного федеральных
округов, коэффициенты при  SBP.2017 и CBE.2016, а также коэффициенты при независимых переменных для некоторых округов. 

*(SBP.2017 с Северо-Западным федеральным округом;*
*CBE.2016 с Северо-Западным и Северо-Кавказским федеральным округом)*


### Модель с поправкой Бонферрони:

Явный вид модели 3: $RTPC.2017 = 9,4863 +2,903 \cdot FOСЗФО -0,3056 \cdot FOСКФО +0,2344 \cdot CBE.2016 -0,0173 \cdot FOПФО.CBE.2016 -0,2567 \cdot FOСЗФО.CBE. -0,0242 \cdot FOСФО.CBE.2016$.


#### Таблица `r table.num` - описательные статистики логарифмированной модели по федеральным округам с поправкой Бонферрони
```{r}
fit.11.foB <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'RTPC.2017',
                                   p.adj.method = 'bonferroni')
kable(round(summary(fit.11.foB)$coef, 4))
table.num <- table.num + 1
```
Коэффициент модели при *FOСКФО.CBE.2016* значим, однако коэффициент детерминации заметно понизился ($R^2 =$ `r round(summary(fit.11.foB)$r.sq, 3)`).



## Сравнение моделей по качеству.

Сравним три полученные модели: изначальную, без поправки по ФО и с поправкой по ФО.

#### Таблица `r table.num` - сравнение двух логарифмированных моделей
```{r}
models.list <- list(fit.11, fit.11.fo, fit.11.foB)
names(models.list) <- c('fit.11', 'fit.11.fo', 'fit.11.foBonferroni')
df.goodness.of.fit <- data.frame(Модель = names(models.list), 
                                       R.2.скорр = 0,
                                       F.расч = 0,
                                       Станд.Ошибка = 0)
for (i in 1:length(models.list)) {
  # скорректированный R-квадрат
  df.goodness.of.fit[i, 'R.2.скорр'] <- 
    round(summary(models.list[[i]])$adj.r.squared, 3)
  # F расчётное
  df.goodness.of.fit[i, 'F.расч'] <- 
    round(summary(models.list[[i]])$fstatistic[1], 2)
  # стандартная ошибка
  df.goodness.of.fit[i, 'Станд.Ошибка'] <- 
    round(summary(models.list[[i]])$sigma, 3)
}
kable(df.goodness.of.fit)
table.num <- table.num + 1
```

Результат: 

По столбцу $R^2$ больше всего подходит третья модель;
По столбцу F.расч - первая;
По минимальной Стандартной ошибке - вторая,



**Явный вид модели: $RTPC.2017 = 9,4863 +2,903 \cdot FOСЗФО -0,3056 \cdot FOСКФО +0,2344 \cdot CBE.2016 -0,0173 \cdot FOПФО.CBE.2016 -0,2567 \cdot FOСЗФО.CBE. -0,0242 \cdot FOСФО.CBE.2016$.**



```{r}
# 4. Сохранение объектов рабочего пространства  -------------------------
save(list = c('data.fit.1.fo', 'data.fit.11.fo', 'fit.1.fo', 'fit.11.fo', 'DF', 'reg.df1', 'reg.df'), 
    file = 'test_lab2_Бессмертная.RData')
```